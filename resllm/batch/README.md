# Batch Processing for LLM Allocation Decisions

This directory contains tools for generating allocation decisions via OpenAI's Batch API. There are two workflows: **standard batch processing** (generate decisions for the full historical period) and **ablation studies** (test the impact of removing specific prompt components).

## Prerequisites

Set `OPENAI_API_KEY` in your `.env` file and ensure dependencies are installed.

---

## Standard Batch Processing

Generate allocation decisions for every monthly decision point from 1996-2016 (252 requests: 21 years × 12 months).

### Data Requirements

The script reads directly from `data/` and `resllm/configs/`:

| File | Required Columns | Description |
|------|------------------|-------------|
| Config YAML | `demand_file`, `inflow_file`, `wy_forecast_file` | Default: `folsom_hist_forecast.yml` |
| Inflow CSV | `date`, `inflow`, `storage`, `outflow` | Historical reservoir data |
| Demand file | (plain text, 365 values) | Daily demand in TAF |
| Forecast CSV | `date`, `QCYFHM`, `QCYFH1`, `QCYFH9` | Mean, 10th, 90th percentile forecasts |

The `storage` and `outflow` columns are used to compute initial conditions and previous allocation estimates.

### Usage

```bash
./run_batch_workflow.sh [OPTIONS]
```

| Argument | Default | Description |
|----------|---------|-------------|
| `--n-samples N` | `1` | Number of independent samples per date |
| `--skip-create` | — | Skip request generation, use existing JSONL file |
| `--batch-id ID` | — | Monitor an already-submitted batch instead of creating new |

**Examples:**
```bash
./run_batch_workflow.sh                       # Single sample per date
./run_batch_workflow.sh --n-samples 10        # 10 samples per date (2520 requests)
./run_batch_workflow.sh --batch-id batch_xyz  # Resume monitoring existing batch
```

### Outputs

| File | Description |
|------|-------------|
| `output/batch_requests_1996_2016.jsonl` | JSONL batch requests |
| `output/batch_requests_metadata_1996_2016.csv` | Request metadata (date, wy, month, storage, etc.) |
| `output/allocation_decisions_1996_2016.csv` | Processed results with allocation decisions |

---

## Ablation Studies

Test the impact of removing specific information from the prompt by isolating a single month and generating decisions with modified observations.

### Data Requirements

Ablation studies read from **existing decision output CSVs** generated by `resllm/simulate.py`. You must first run simulations to generate these files:

```bash
cd resllm
python simulate.py \
  --model-server OpenAI \
  --model o4-mini-2025-04-16 \
  --config folsom.yml \
  --start-year 1996 \
  --end-year 2016 \
  --starting-storage 466.1 \
  --nsample 10
```

This creates 10 files in `resllm/output/`:
- `o4-mini-2025-04-16_decision_output_n0.csv`
- `o4-mini-2025-04-16_decision_output_n1.csv`
- ... through `n9.csv`

Each file contains an `observation` column with the full prompt text. The ablation script parses and modifies this text to remove specific components.

### Usage

```bash
./run_ablation_workflow.sh --ablation-type TYPE --month N [OPTIONS]
```

| Argument | Required | Default | Description |
|----------|----------|---------|-------------|
| `--ablation-type TYPE` | Yes | — | Which information to remove (see below) |
| `--month N` | Yes | — | Month of water year (1-12) |
| `--model-prefix PREFIX` | No | `o4-mini-2025-04-16` | Prefix for decision output filenames |
| `--skip-create` | No | — | Skip request generation, use existing file |
| `--batch-id ID` | No | — | Monitor existing batch |

**Ablation types:**

| Type | Removes |
|------|---------|
| `current_storage` | "There is currently X TAF in storage" |
| `cumulative_inflow` | "So far this water year, X TAF of inflow has been observed" |
| `remaining_demand` | "There is approximately X TAF of demand to meet" |
| `previous_allocation` | "The previous percent allocation decision was X percent" |
| `forecasts` | All probabilistic forecast information |
| `forecast_mean` | Mean forecast only |
| `forecast_p10` | 10th percentile forecast only |
| `forecast_p90` | 90th percentile forecast only |
| `storage_and_inflow` | Both storage and cumulative inflow |
| `next_year_demand` | Next water year demand reminder (months 9-12) |
| `no_system` | Entire system prompt (keeps only observation) |
| `minimal` | Everything except basic allocation request |
| `bare_minimal` | Generic "provide a percent" prompt |

**Examples:**
```bash
./run_ablation_workflow.sh --ablation-type current_storage --month 6
./run_ablation_workflow.sh --ablation-type forecasts --month 9 --batch-id batch_xyz
./run_ablation_workflow.sh --ablation-type minimal --month 3 --model-prefix gpt-4o
```

### Outputs

For ablation type `current_storage` and month `6`:

| File | Description |
|------|-------------|
| `output/ablation_current_storage_month6_requests.jsonl` | Modified batch requests |
| `output/ablation_current_storage_month6_metadata.csv` | Request metadata |
| `output/ablation_current_storage_month6_results.csv` | Processed allocation decisions |

Each ablation generates 210 requests (21 years × 10 samples).

---

## Python Modules

For manual control or debugging, run the individual scripts directly from `src/`:

| Script | Purpose | Key Arguments |
|--------|---------|---------------|
| `create_batch_requests.py` | Generate standard batch JSONL | `--n-samples N` |
| `create_ablation_batch_requests.py` | Generate ablation batch JSONL | `--month N`, `--ablation-type TYPE`, `--model-prefix PREFIX` |
| `submit_batch.py` | Upload and submit to OpenAI | `upload --file FILE`, `create --file-id ID` |
| `monitor_batch.py` | Poll until completion | `--batch-id ID`, `--interval SECS` |
| `process_batch_results.py` | Parse results to CSV | `--results FILE`, `--metadata FILE`, `--output FILE` |
| `verify_batch_requests.py` | Validate JSONL format | `--file FILE` |

